<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.recycle.ecoeco.board.notice.model.dao.manager.AdminNoticeMapper">

    <resultMap type="com.recycle.ecoeco.board.notice.model.dto.NoticeDTO" id="noticeResultMap" >
        <id property="noticeNo" column="noticeNo"/>
        <!--        <result property="noticeCategory" column="noticeCategory"/>-->
        <association property="writer" resultMap="userResultMap"/>
    </resultMap>

    <resultMap type="com.recycle.ecoeco.membership.model.dto.UserInfoDTO" id="userResultMap" >
        <id property="userNo" column="userNo"/>
    </resultMap>

    <!-- 공지사항 조회 리스트 카운트 -->
    <select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
        COUNT(*)
        FROM
        NOTICE b
        <if test="searchCondition == 'writer'">
            JOIN
            USER_INFO u ON(b.userNo = u.userNo)
        </if>
        <where>
            <if test="searchCondition == 'noticeCategory'">
                b.noticeCategory = #{ searchValue }
            </if>
            AND
            b.noticeStatus = 'Y'
        </where>
    </select>

    <!-- 공지사항 전체 목록 조회 -->
    <select id="selectNoticeList" resultMap="noticeResultMap">
        SELECT
        b.noticeNo,
        b.noticeCategory,
        b.noticeTitle,
        b.noticeDate,
        u.userName
        FROM
        NOTICE b
        JOIN
        USER_INFO u ON (b.userNo = u.userNo)
        <where>
            <if test="searchCondition == 'noticeTitle'">
                b.noticeTitle LIKE CONCAT('%', #{ searchValue }, '%')
            </if>
            <if test="searchCondition == 'noticeCategory'">
                <choose>
                    <when test="searchValue == '공지사항'">
                        b.noticeCategory = '공지사항'
                    </when>
                    <when test="searchValue == '이벤트'">
                        b.noticeCategory = '이벤트'
                    </when>
                    <when test="searchValue == 'FAQ'">
                        b.noticeCategory = 'FAQ'
                    </when>
                </choose>
            </if>
            AND
            b.noticeStatus = 'Y'
        </where>
        ORDER BY
        b.noticeNo DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 공지사항 상세 조회 -->
    <select id="selectNoticeDetail" resultMap="noticeResultMap">
        SELECT
        b.noticeNo,
        b.noticeCategory,
        b.noticeSubCategory,
        b.noticeTitle,
        b.noticeDate,
        b.noticeDetail,
        u.userName
        FROM
        NOTICE b
        JOIN
        USER_INFO u ON (b.userNo = u.userNo)
        WHERE
        b.noticeNo = #{noticeNo}
    </select>

    <insert id="insertNotice">
        INSERT INTO NOTICE
        (noticeCategory, noticeSubCategory, noticeTitle, noticeDetail, noticeDate, userNo)
        VALUES
        (#{ noticeCategory }, #{ noticeSubCategory }, #{ noticeTitle }, #{ noticeDetail }, current_date(), #{ writer.userNo })
        <selectKey keyProperty="noticeNo" order="AFTER" resultType="int">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <update id="deleteNotice">
        UPDATE
        Notice
        SET
        noticeStatus = 'N'
        WHERE
        noticeNo = #{ noticeNo }
    </update>

    <select id="noticeModify" resultMap="noticeResultMap">
        SELECT
        b.noticeNo,
        b.noticeCategory,
        b.noticeSubCategory,
        b.noticeTitle,
        b.noticeDetail,
        b.noticeDate,
        m.userNo
        FROM
        NOTICE b
        JOIN
        USER_INFO m ON (b.userNo = m.userNo)
        WHERE
        noticeNo = #{ noticeNo }
    </select>

    <!-- 공지사항 수정 등록 -->
    <update id="updateNotice">
        UPDATE
        NOTICE
        SET
        noticeCategory = #{ noticeCategory },
        noticeSubCategory = #{ noticeSubCategory },
        noticeTitle = #{ noticeTitle },
        noticeDate = #{ noticeDate },
        noticeDetail = #{ noticeDetail }
        WHERE
        noticeStatus = 'Y'
        AND
        noticeNo = #{ noticeNo }
    </update>

</mapper>